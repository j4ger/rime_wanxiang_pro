name: Nightly Build dicts

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 14 * * *" # æ¯å¤©æ™šä¸Š 10 ç‚¹

concurrency: # é˜²æ­¢å¹¶å‘å†²çª
  group: nightly-release
  cancel-in-progress: true

jobs:
  nightly-release:
    runs-on: ubuntu-22.04

    steps:
      # âœ… 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… 2. è·å– "amzxyz/RIME-LMDG" çš„ `dict-nightly` Release é‡Œçš„å›ºå®šæ–‡ä»¶
      - name: Get dict-nightly release file
        id: get_source_release
        run: |
          SOURCE_REPO="amzxyz/RIME-LMDG" # âš ï¸ ç›®æ ‡ä»“åº“
          FILE_NAME="wanxiang-lts-zh-hans.gram" # éœ€è¦è·å–çš„æ–‡ä»¶å
          TAG_NAME="dict-nightly" # å›ºå®š Release tag

          # è·å–æŒ‡å®š tagï¼ˆdict-nightlyï¼‰çš„ Release API
          API_URL="https://api.github.com/repos/$SOURCE_REPO/releases/tags/$TAG_NAME"
          echo "ğŸ” æŸ¥è¯¢ Release: $API_URL"
          
          # è·å– JSON å“åº”
          RESPONSE=$(curl -s "$API_URL")

          # æå–è¯¥ tag Release é‡Œçš„ `wanxiang-lts-zh-hans.gram` ä¸‹è½½é“¾æ¥
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r ".assets[] | select(.name==\"$FILE_NAME\") | .browser_download_url")

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "âŒ æœªæ‰¾åˆ° $FILE_NAMEï¼Œè¯·æ£€æŸ¥ Release æ˜¯å¦åŒ…å«è¯¥æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… æ‰¾åˆ°æ–‡ä»¶ï¼Œä¸‹è½½åœ°å€: $DOWNLOAD_URL"
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      # âœ… 3. ä¸‹è½½è¯¥æ–‡ä»¶
      - name: Download release file
        run: |
          wget -O wanxiang-lts-zh-hans.gram "$DOWNLOAD_URL"
          ls -lah wanxiang-lts-zh-hans.gram # ç¡®ä¿æ–‡ä»¶ä¸‹è½½æˆåŠŸ

      # âœ… 4. æ‰“åŒ… cn_dicts.zipï¼ˆä¸åŒ…å« wanxiang-lts-zh-hans.gramï¼‰
      - name: Pack cn_dicts
        run: |
          mkdir -p dist
          if [ -d "cn_dicts" ]; then
            zip -r dist/cn_dicts.zip cn_dicts
            echo "âœ… Packing completed: dist/cn_dicts.zip"
          else
            echo "âŒ Error: cn_dicts folder does not exist."
            exit 1
          fi

      # âœ… 5. åˆ é™¤æ—§çš„ Release å’Œ Tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Delete existing Nightly Release and Tag
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = "dict-nightly";
            try {
              const releases = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const existingRelease = releases.data.find(r => r.tag_name === tag);
              if (existingRelease) {
                console.log(`Deleting existing Release with ID: ${existingRelease.id}`);
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: existingRelease.id
                });
              }

              console.log(`Deleting tag: ${tag}`);
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`
              });
            } catch (error) {
              console.log(`No existing Release/Tag found or failed to delete: ${error.message}`);
            }

      # âœ… 6. ç­‰å¾… GitHub æ¸…ç†æ—§æ•°æ®
      - name: Wait for cleanup
        run: sleep 10

      # âœ… 7. åˆ›å»ºæ–°çš„ Releaseï¼Œå¹¶ä¸Šä¼  `cn_dicts.zip` å’Œ `wanxiang-lts-zh-hans.gram`
      - name: Create new Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: dict-nightly
          name: "æ¯å¤œæ„å»º-è¯åº“æ›´æ–°"
          body: |
            - `cn_dicts.zip`ï¼šæœ€æ–°çš„ä¸­æ–‡è¯åº“æ–‡ä»¶ã€‚
            - `wanxiang-lts-zh-hans.gram`ï¼šä¸è¯åº“é«˜åº¦é…åˆçš„è¯­æ³•æ¨¡å‹ã€‚
          files: |
            dist/cn_dicts.zip
            wanxiang-lts-zh-hans.gram
          draft: false
          prerelease: false
          make_latest: true
